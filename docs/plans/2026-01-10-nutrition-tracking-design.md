# Nutrition Tracking Design

**Date:** 2026-01-10
**Status:** Approved

## Overview

Add macro tracking to KitchenOS. Store nutrition data per recipe, define daily targets, and generate a dashboard showing daily totals vs targets for each week.

## Goals

- Track basic macros: Calories, Protein, Carbs, Fat
- Auto-lookup nutrition from APIs during recipe extraction
- View daily totals vs personal targets in a dashboard
- Keep meal plans clean (no portion notation needed)

## Data Sources (Priority Chain)

1. **Nutritionix API** - Best natural language parsing for ingredients
2. **USDA FoodData Central** - Free fallback, reliable government database
3. **AI estimation** - Ollama fallback when APIs fail
4. **Manual override** - User can always correct values

## Recipe Nutrition Structure

### Frontmatter Additions

```yaml
# Existing fields...
servings: 4
serving_size: "1 cup"

# New nutrition fields (per serving)
calories: 450
protein: 25
carbs: 45
fat: 18
nutrition_source: "nutritionix"  # or "usda", "ai", "manual"
```

### New Recipe Section

Add after Ingredients, before Instructions:

```markdown
## Nutrition (per serving)

| Calories | Protein | Carbs | Fat |
|----------|---------|-------|-----|
| 450      | 25g     | 45g   | 18g |

*Serving size: 1 cup • Source: Nutritionix*
```

Frontmatter holds raw numbers for Dataview calculations. Section provides human-readable display.

## Macro Targets Storage

**File:** `My Macros.md` (vault root)

```markdown
---
calories: 2000
protein: 150
carbs: 200
fat: 65
---

# My Daily Macros

| Macro    | Target |
|----------|--------|
| Calories | 2000   |
| Protein  | 150g   |
| Carbs    | 200g   |
| Fat      | 65g    |

## Notes

<!-- Track why you set these targets, adjustments over time, etc. -->
```

## Nutrition Dashboard

**File:** `Nutrition Dashboard.md` (vault root)

```markdown
---
week: 2026-W03
generated: 2026-01-15T08:30:00
---

# Nutrition Dashboard

**Week:** [[2026-W03|Week 3 (Jan 13 - Jan 19)]]
**Targets:** [[My Macros]]

## Daily Summary

| Day       | Calories     | Protein    | Carbs      | Fat       |
|-----------|--------------|------------|------------|-----------|
| Monday    | 1850 / 2000  | 140 / 150g | 180 / 200g | 60 / 65g  |
| Tuesday   | 2100 / 2000  | 160 / 150g | 210 / 200g | 70 / 65g  |
| Wednesday | 1950 / 2000  | 145 / 150g | 195 / 200g | 62 / 65g  |
| Thursday  | —            | —          | —          | —         |
| Friday    | —            | —          | —          | —         |
| Saturday  | —            | —          | —          | —         |
| Sunday    | —            | —          | —          | —         |

## Week Averages

| Macro    | Average | Target | Difference |
|----------|---------|--------|------------|
| Calories | 1967    | 2000   | -33        |
| Protein  | 148g    | 150g   | -2g        |
| Carbs    | 195g    | 200g   | -5g        |
| Fat      | 64g     | 65g    | -1g        |

---
*Generated by KitchenOS • [Refresh](http://localhost:5001/refresh-nutrition?week=2026-W03)*
```

Shows actual/target format. Dashes for days without meals planned.

## Nutrition Lookup Pipeline

### Flow

```
Recipe extracted → ingredients list ready
    ↓
For each ingredient:
    1. Nutritionix API (parse "2 cups flour" naturally)
    2. If no match → USDA FoodData Central
    3. If no match → flag for AI estimation
    ↓
Sum all ingredients → divide by servings
    ↓
Store per-serving values in recipe
```

### Key Functions

**File:** `lib/nutrition_lookup.py`

- `lookup_nutritionix(ingredient: str) → NutritionData | None`
- `lookup_usda(ingredient: str) → NutritionData | None`
- `estimate_with_ai(ingredients: list) → NutritionData`
- `calculate_recipe_nutrition(ingredients: list, servings: int) → NutritionData`

### Handling Uncertainty

- If any ingredient fails all lookups, set `nutrition_source: "ai"` and `needs_review: true`
- Add `confidence_notes` explaining which ingredients were estimated

### API Configuration

Add to `.env`:
```
NUTRITIONIX_APP_ID=your_app_id
NUTRITIONIX_API_KEY=your_api_key
```

USDA requires no key (optional key for higher rate limits).

## Dashboard Generation

### Process

```
1. Read My Macros.md → extract targets from frontmatter
2. Read meal plan for given week (e.g., 2026-W03.md)
3. For each day:
   - Parse recipe links from Breakfast/Lunch/Dinner
   - For each recipe link:
     - Read recipe file → extract nutrition from frontmatter
     - Add to daily totals (1 serving per link)
   - Store day totals
4. Calculate week averages
5. Write Nutrition Dashboard.md
```

### Commands

```bash
# Generate for current week
.venv/bin/python generate_nutrition_dashboard.py

# Generate for specific week
.venv/bin/python generate_nutrition_dashboard.py --week 2026-W03
```

### API Endpoint

```
GET /refresh-nutrition?week=2026-W03
```

### Edge Cases

- Recipe without nutrition data → show "?" and note in dashboard footer
- Empty meal slot → contributes 0 to totals
- Recipe link not found → warn in output, skip

## Implementation Plan

### New Files

| File | Purpose |
|------|---------|
| `lib/nutrition_lookup.py` | API clients for Nutritionix, USDA, AI fallback |
| `generate_nutrition_dashboard.py` | Dashboard generator script |
| `My Macros.md` (in vault) | User's daily macro targets |
| `Nutrition Dashboard.md` (in vault) | Generated dashboard output |

### Modified Files

| File | Changes |
|------|---------|
| `templates/recipe_template.py` | Add nutrition frontmatter fields + Nutrition section |
| `extract_recipe.py` | Call nutrition lookup after recipe extraction |
| `api_server.py` | Add `/refresh-nutrition` endpoint |
| `CLAUDE.md` | Document new commands and config |
| `.env` | Add Nutritionix API credentials |

### Implementation Order

1. Nutrition lookup library (API integrations)
2. Recipe template updates
3. Wire into extraction pipeline
4. Dashboard generator
5. API endpoint
6. Migration for existing recipes (add nutrition to old recipes)
