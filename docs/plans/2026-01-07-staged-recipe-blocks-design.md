# Staged Recipe Blocks Design

## Overview

Break recipes into time-based stages (preprep, prep, cooking, etc.) to enable meal planning across multiple days. Users can schedule meals on a calendar, and the system calculates backwards to show what prep needs to happen on which days.

## Problem

Cooking videos often have steps that benefit from advance preparation - marinades, brines, doughs that need to rest, bringing meat to room temperature. Currently, recipes are a flat list of instructions with no way to:
- Know what can be done ahead of time
- Plan prep across multiple days
- Get reminders for time-sensitive advance steps

## Solution

### Five Recipe Stages

| Stage | Purpose | Example Timing |
|-------|---------|----------------|
| **days_ahead** | Marinades, brines, doughs needing 12+ hours | "12-24 hours before" |
| **hours_ahead** | Room temp, soaking, thawing | "30 min - 2 hours before" |
| **mise_en_place** | Chopping, measuring, organizing | "15-30 min before" |
| **active_cooking** | The actual cooking | "at serving time" |
| **resting_finishing** | Resting meat, garnishes, plating | "after cooking" |

Only stages with actual content appear in each recipe - a quick stir-fry won't show empty "days_ahead" sections.

---

## Data Model

### Recipe Frontmatter Changes

```yaml
---
title: "Honey Garlic Chicken"
source_url: "https://youtube.com/watch?v=XYZ"
# ... existing fields ...

# NEW: Stage definitions
stages:
  - name: "days_ahead"
    timing: "4-24 hours before"
    required: true
    source: "explicit"  # from video
  - name: "hours_ahead"
    timing: "30 min before"
    required: false
    source: "suggested"  # AI best practice
  - name: "mise_en_place"
    timing: "15 min before"
    required: true
    source: "explicit"
  - name: "active_cooking"
    timing: "at serving time"
    required: true
    source: "explicit"
---
```

### Stage Fields

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | One of: days_ahead, hours_ahead, mise_en_place, active_cooking, resting_finishing |
| `timing` | string | Flexible range relative to serving time (e.g., "4-24 hours before") |
| `required` | boolean | Can this stage be skipped, or is it essential? |
| `source` | string | "explicit" (from video) or "suggested" (AI best practice) |

### Recipe Body Structure

```markdown
## Days-Ahead Prep (4-24 hours before)
- [ ] Combine soy sauce, honey, garlic, and ginger for marinade
- [ ] Add chicken thighs to marinade, refrigerate

## Hours-Ahead Prep (30 min before) *(suggested)*
- [ ] Remove chicken from fridge to come to room temperature

## Mise en Place (15 min before)
- [ ] Slice green onions for garnish
- [ ] Measure sesame oil and rice vinegar
- [ ] Prepare serving platter

## Active Cooking
1. Heat large skillet over medium-high heat
2. Remove chicken from marinade, reserve marinade
3. Sear chicken 4-5 minutes per side until golden
4. Add reserved marinade to pan, simmer until thickened (5 min)
5. Garnish with sesame seeds and green onions

## Resting & Finishing
- [ ] Let chicken rest 5 minutes before serving
- [ ] Drizzle with remaining sauce
```

---

## Meal Planning

### Meal Plan File Structure

Location: `Meal Plans/2026-W02.md`

```markdown
---
week_of: 2026-01-05
---

# Week of January 5, 2026

## Scheduled Meals

| Day | Meal | Recipe | Serving Time |
|-----|------|--------|--------------|
| Mon | Dinner | [[Honey Garlic Chicken]] | 6:00 PM |
| Tue | Dinner | [[Quick Stir Fry]] | 7:00 PM |
| Wed | Dinner | [[Slow Braised Short Ribs]] | 6:30 PM |
| Thu | Dinner | [[Leftover Short Ribs]] | 6:00 PM |
| Fri | Dinner | [[Sheet Pan Salmon]] | 7:00 PM |

## Daily Prep Schedule

<!-- Auto-generated by Dataview -->
```

### Dataview Query: Daily Prep List

```dataview
TABLE WITHOUT ID
  recipe.file.link AS "Recipe",
  stage.name AS "Stage",
  stage.timing AS "Timing",
  tasks AS "Tasks"
FROM "Meal Plans"
WHERE week_of = date(today).startOf("week")
FLATTEN stages as stage
WHERE stage.start_date = date(today)
```

### Auto-Generated Daily View

```markdown
## Today's Prep (Monday, Jan 6)

### For Tonight: Honey Garlic Chicken (6:00 PM)
- [ ] 5:45 PM - Mise en place: slice green onions, measure ingredients

### For Wednesday: Slow Braised Short Ribs (6:30 PM)
- [ ] Anytime today - Days-ahead: Season short ribs with salt and pepper
- [ ] Anytime today - Days-ahead: Prepare mirepoix, refrigerate
```

---

## Calendar Sync

### Obsidian to External Calendar Flow

```
Obsidian Meal Plan
       ↓
Obsidian Tasks / Full Calendar Plugin
       ↓
ICS Export
       ↓
Apple Calendar / Google Calendar
       ↓
Phone Notifications
```

### Calendar Event Format

Each prep task becomes a calendar event:

| Field | Value |
|-------|-------|
| Title | "Prep: Marinate chicken (Honey Garlic Chicken)" |
| Start | Calculated from serving time minus stage timing |
| Duration | 15 min (default for prep tasks) |
| Notes | Link to recipe in Obsidian |
| Alert | 30 min before (configurable) |

### Timing Calculation Example

```
Serving time: Wednesday 6:30 PM
Stage: days_ahead (12-24 hours before)

Earliest start: Tuesday 6:30 PM (24 hours before)
Latest start: Wednesday 6:30 AM (12 hours before)
Calendar event: Tuesday 6:30 PM (uses earliest for buffer)
```

---

## AI Extraction

### Stage Detection Signals

| Signal in Transcript | Maps To |
|---------------------|---------|
| "the night before", "day ahead", "let marinate overnight" | days_ahead |
| "for at least X hours" (X > 4) | days_ahead |
| "bring to room temperature", "take out of fridge" | hours_ahead |
| "for at least X hours" (X < 4) | hours_ahead |
| "prep your vegetables", "chop", "dice", "measure out" | mise_en_place |
| "sear", "saute", "bake", "simmer", "cook until" | active_cooking |
| "let rest", "garnish", "plate", "serve" | resting_finishing |

### Best Practice Suggestions

AI adds these even when video doesn't mention them:

| Ingredient/Technique | Suggested Stage | Timing | Rationale |
|---------------------|-----------------|--------|-----------|
| Raw poultry/beef | hours_ahead | "30 min before" | Even cooking |
| Dried beans (not instant pot) | days_ahead | "8-12 hours before" | Reduce cook time |
| Yeast dough | days_ahead | "8-24 hours before" | Cold-proof option for flavor |
| Thick steaks | hours_ahead | "45 min before" | Room temp for even sear |
| Roasted meat | resting_finishing | "10-15 min after" | Juice redistribution |
| Pasta water | mise_en_place | "10 min before" | Water takes time to boil |

### Extraction Prompt Addition

```
When extracting recipe instructions, categorize each step into one of these stages:
- days_ahead: Steps that must/should happen 12+ hours before serving
- hours_ahead: Steps that should happen 1-4 hours before serving
- mise_en_place: Prep work done 15-30 minutes before cooking
- active_cooking: The actual cooking process
- resting_finishing: Post-cooking steps before serving

For each stage, specify:
- timing: A flexible range (e.g., "4-24 hours before")
- required: true if skipping would ruin the dish, false if optional
- source: "explicit" if mentioned in video, "suggested" if you're adding as best practice

Add best practice suggestions for common ingredients even if the video doesn't mention them.
Mark these with source: "suggested" so users know it's a recommendation.
```

### Output JSON Structure

```json
{
  "recipe_name": "Honey Garlic Chicken",
  "stages": [
    {
      "name": "days_ahead",
      "timing": "4-24 hours before",
      "required": true,
      "source": "explicit",
      "steps": [
        {"text": "Combine marinade ingredients", "checkbox": true},
        {"text": "Add chicken to marinade, refrigerate", "checkbox": true}
      ]
    },
    {
      "name": "hours_ahead",
      "timing": "30 min before",
      "required": false,
      "source": "suggested",
      "steps": [
        {"text": "Remove chicken from fridge to room temperature", "checkbox": true}
      ]
    },
    {
      "name": "mise_en_place",
      "timing": "15 min before",
      "required": true,
      "source": "explicit",
      "steps": [
        {"text": "Slice green onions", "checkbox": true},
        {"text": "Measure sauce ingredients", "checkbox": true}
      ]
    },
    {
      "name": "active_cooking",
      "timing": "at serving time",
      "required": true,
      "source": "explicit",
      "steps": [
        {"step": 1, "text": "Heat skillet over medium-high", "time": null},
        {"step": 2, "text": "Sear chicken 4-5 min per side", "time": "8-10 min"},
        {"step": 3, "text": "Add marinade, simmer until thick", "time": "5 min"}
      ]
    },
    {
      "name": "resting_finishing",
      "timing": "after cooking",
      "required": false,
      "source": "suggested",
      "steps": [
        {"text": "Let chicken rest 5 minutes", "checkbox": true},
        {"text": "Garnish with sesame seeds and green onions", "checkbox": true}
      ]
    }
  ]
}
```

---

## Implementation Phases

### Phase 1: Schema Extension
**Goal:** Add stage support to recipe format

- [ ] Add `stages` field to recipe YAML frontmatter schema
- [ ] Update markdown template to render stages with checkboxes
- [ ] Update AI extraction prompt to identify and categorize stages
- [ ] Add best practice suggestion logic for common ingredients
- [ ] Ensure backwards compatibility (recipes without stages still work)

**Deliverables:**
- Updated recipe template
- Updated AI extraction prompt
- Example recipe with stages

### Phase 2: Meal Planning
**Goal:** Schedule meals and generate prep lists

- [ ] Create `Meal Plans/` folder structure
- [ ] Build meal plan template with weekly table format
- [ ] Write Dataview queries to calculate prep dates from serving times
- [ ] Generate daily prep task lists automatically
- [ ] Handle timezone considerations for timing calculations

**Deliverables:**
- Meal plan template
- Dataview queries for prep scheduling
- Daily prep view

**Dependencies:** Phase 1 (needs stage data)

### Phase 3: Calendar Sync
**Goal:** Get prep reminders on phone

- [ ] Configure Obsidian Tasks or Full Calendar plugin
- [ ] Set up ICS export format for prep tasks
- [ ] Configure sync to Apple Calendar / Google Calendar
- [ ] Set default reminder times for different stage types
- [ ] Test notification flow end-to-end

**Deliverables:**
- Calendar plugin configuration
- ICS export setup
- Sync instructions

**Dependencies:** Phase 2 (needs meal plan with serving times)

### Phase 4: Polish & Enhancements
**Goal:** Quality of life improvements

- [ ] Grocery list generation grouped by purchase timing
- [ ] "Start cooking" focused view (only active_cooking steps)
- [ ] Historical tracking ("last made on X, started marinade at Y")
- [ ] Recipe scaling with stage timing adjustments
- [ ] Batch cooking support (one prep, multiple meals)

**Dependencies:** Phases 1-3 complete

---

## Open Questions

1. **Notification preferences** - How many hours before each stage type should reminders fire?
2. **Missed prep handling** - What happens if you miss a days_ahead window? Reschedule meal or show warning?
3. **Recipe variants** - Same recipe with different timing (quick version vs. best version)?
4. **Shared meal plans** - Multiple people in household coordinating prep?

---

## Success Criteria

- [ ] Can extract staged recipes from YouTube videos with AI
- [ ] Can schedule a meal and see calculated prep dates
- [ ] Prep tasks appear on phone calendar with reminders
- [ ] Suggested best practices are visually distinct from explicit instructions
- [ ] Existing recipes without stages continue to work
